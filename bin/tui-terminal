#!/usr/bin/env bash
#
# Copyright (c) 2014-2015 Simon Arjuna Erat (sea)  <erat.simon@gmail.com>
# All rights reserved.
#
# This program is free software: you can redistribute it and/or modify it
# under the terms of the GNU General Public License as published
# by the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <http://www.gnu.org/licenses/>
#
# ------------------------------------------------------------------------
#
#	Init TUI environment
#
	if source /etc/tuirc && source "$HOME/.tuirc"
	then	for f in $TUI_FILE_{CONF,USER}_{APPS,COMMANDS,SETTINGS};do source "$f";done
	else	source tuirc
	fi
	break_on_injections "$@" && exit 1
#
#	Variable defaults
#
	script_version=0.8.0
	ME="${0##*/}"
#
#	Check for the environment to load
#
	! tui-bol-gui && \
		tui-printf -S 1 "$ME: Requires to be in GUI mode" && \
		exit 1
	
	if ! which $TERMINAL 2>/dev/zero 1>/dev/zero
	then	# List of known but possible unhandled terminals
		list="$(<$TUI_DIR_LIST/terminals)"
		found=false
		for TERMINAL in $list;do
			which $TERMINAL 1>/dev/zero 2>/dev/zero && found=true && break
		done
		$found && tui-conf-set -v ${TUI_USER_CONF/user/apps/} TERMINAL $TERMINAL
		! $found && \
			tui-printf -S 1 "FATAL ERROR: No terminal could be identified, please set one manually in $APPS!" && \
			exit 1
	fi
#
#	Variable handling
#
	case "$1" in
	"--version")
		cat <<-EOF
			GNU $ME, Version $script_version
			Copyright (C) 2015 Simon Arjuna Erat
			License GPLv3+: GNU GPL version 3 or later <http://gnu.org/licenses/gpl.html>

			This is free software; you are free to change and redistribute it.
			There is NO WARRANTY, to the extent permitted by law.
		EOF
		exit 0
		;;
	"-h"|"--help")
		printf '%s\n' \
			"$ME ($script_version)" \
			"Usage: $ME \"<cmd>\"" \
			"Executes <cmd> in another terminal ($TERMINAL) window, closes on termination according to your setting with that terminal." \
			""
		exit $RET_HELP
		;;
	esac
	#ARGS="${@}"
	
	# Handle 'known' terminal emulators
	case "$TERMINAL" in
	gnome-terminal|lxterminal|vte|[eipx]term)
		[ -z "$1" ] && opt="" || opt="-e "	;;
	termit)
		[ -z "$1" ] && opt="" || opt="-c "	;;
	*)	# Handle 'unknown' terminal emulators, assuming defaults
		[ -z "$1" ] && opt="" || opt="-e "
		# Fill the fallback, to avoid empty calls
		TERMINAL="${TERMINAL:-xterm}"
		tui-echo "$TERMINAL: Using 'default' option \"$opt\", please report your terminal ($TERMINAL) and its command execution option." > /dev/stderr
		;;
	esac
#
#	Display
#
	#$TERMINAL $opt "${ARGS[@]}"
	$TERMINAL $opt "$1"
	