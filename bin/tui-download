#!/usr/bin/env bash
#
# Copyright (c) 2013-2015 Simon Arjuna Erat (sea)  <erat.simon@gmail.com>
# All rights reserved.
#
# This program is free software: you can redistribute it and/or modify it
# under the terms of the GNU General Public License as published
# by the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <http://www.gnu.org/licenses/>
#
# ------------------------------------------------------------------------
#
#	Init TUI environment
#
	ME="${0##*/}"
	for tmp_task in "/etc" "${HOME:-/root}/.local" "$HOME"
	do 	[ -f "$tmp_task/tui.conf" ] && source "$tmp_task/tui.conf" && [ ! -z "${SYSCONFDIR}!" ] && break
	done
	# Get the main config files
	# 
	if source "${SYSCONFDIR}/tuirc" && source "${HOME:-/root}/.tuirc" 2>/dev/zero
	then 	# Load required variables
		for f in $TUI_FILE_{CONF,USER}_{APPS,COMMANDS,SETTINGS}
		do	[ -f "$f" ] && source "$f"
		done
		# Load language
		if [ -z "$TUI_LANG" ]
		then	[ -z "$LANG" ] && LANG=$(locale|sed s,[=\"],\ ,g|awk '/MESS/ {print $2}')
			lng="$(echo ${LANG/\.*})"
			echo "$TUI_DIR_LOCALE/"* | grep -q "${lng}" && \
				tui-conf-set "${HOME:-/root}/.tuirc" TUI_LANG "$lng" || \
				tui-conf-set "${HOME:-/root}/.tuirc" TUI_LANG en_GB
			# Sadly this echo is required to remove tailing spaces, probablly an issue of tui-conf-get (2015.08.21)
			TUI_LANG="$(echo $(tui-conf-get "${HOME:-/root}/.tuirc" TUI_LANG))"
		fi
		LANG_FILE=${ME/tui\-}.sh
		LANG_FILE="$TUI_DIR_LOCALE/${TUI_LANG}/$LANG_FILE"
		[ -f "$LANG_FILE" ] && source "$LANG_FILE" #|| tui-status 3 "$ME -- language file"
	else	source tuirc
	fi
	break_on_injections "$@" && exit 1
#	Created: 2013.09.13
#	Changed: 2015.08.03
#
#
#	Variable defaultsa
#
	TUI_DIR_TEMP="${TUI_DIR_TEMP:-${TMPDIR:-${HOME:-/root}/.cache}}"
	script_version=0.8.9
	ME="${0##*/}"
	help_text="$(gettext "
Usage: $ME [options] URL [URL2] ..
Where options are:
	-h\tThis screen
")"
	ARGS=( "${@}" )
	FILE_TEMP="$TUI_DIR_TEMP/tui-download.status"
	FILE_CMD="$TUI_DIR_TEMP/bgjob"
	DEST="" 
	tui-bol-dir "$TUI_DIR_TEMP"  > /dev/zero
	#tui-echo "Downloading to:"  "$(pwd)"
	LIST_APPS="wget curl"
	[ -z "$(which $CURLWGET 2>/dev/zero)" ] && \
		CURLWGET="$(echo ${LIST_APP/$CURLWGET})"
	TERM="${TERM:-GNU/Linux}"
#
#	Messages
#
	MSG_INIT_ACT="Starting new download..."
	MSG_ACT_ING="Downloading..."
	MSG_ACT_ED="Downloaded"
	MSG_NOTFOUND="Could find neither curl nor wget!"
	MSG_SELECT="Which one to install?"
	MSG_INSTALL_ING="Installing"
	MSG_INSTALL_ED="Installed"
#
#	Variable handling
#
	version_text="$(gettext "
GNU $ME, Version $script_version
Copyright (C) 2015 Simon Arjuna Erat
License GPLv3+: GNU GPL version 3 or later <http://gnu.org/licenses/gpl.html>

This is free software; you are free to change and redistribute it.
There is NO WARRANTY, to the extent permitted by law.
")"
	case "$1" in
	"--version")	printf "$version_text"
			exit 0
			;;
	"-h"|"--help")	printf "$help_text" ; exit $RET_HELP
		;;
	"")	unset ARGS[@]
		ARGS[0]=$(tui-read "Enter URL to download:")
	esac
#
#	Display
#
	if [ -z "$CURLWGET" ]
	then	# Not set yet.
		for app in $LIST_APPS;do
			which "$app" 1>/dev/zero 2>/dev/zero && \
				CURLWGET="$app" && \
				break
		done
		#set -x
		tui-conf-set "$APPS" CURLWGET "$CURLWGET"
	fi
	case "$CURLWGET" in
	curl)	OPT_O="-o"
		OPT_Q="-s"
		OPT_C=""	;;
	wget)	OPT_O="-O"
		OPT_Q="-q"
		OPT_C="-c"	;;
	"")	tui-status 1 "$MSG_NOTFOUND"
		tui-echo "$MSG_SELECT"
		CURLWGET="$(tui-select curl wget)"
		which "$CURLWGET" 1>/dev/zero && \
			tui-conf-set "$APPS" CURLWGET $CURLWGET || \
			exit 1
		tui-asroot "tui-install $CURLWGET"
		;;
	esac
	
	for URL in "${ARGS[@]}"
	do 	THIS="${URL##*/}"
		out_string="./$THIS"
		
		tui-printf -rS 2 "$MSG_INIT_ACT" #"$WORK"
		echo "$CURLWGET $OPT_Q $OPT_C $OPT_O \"$THIS\" \"$URL\"" > "$FILE_CMD"
		
		chmod +x "$FILE_CMD"
		"$FILE_CMD" &
		sleep 0.5
		
		str_left="$MSG_ACT_ING"
		str_middle="$THIS ($tmp_size)"	; len=${#str_middle}
		
		# While its found, assume its till downloading...
		while [ ! "" = "$(ps|$GREP $CURLWGET)" ] #|| [ ! "" = "$(ps $!)" ]
		do	tmp_size="$(ls -hl |$GREP $THIS |$AWK '{print $5}')"
			COLUMNS="$(tput cols)"
			str_middle="$THIS ($tmp_size)"
			tui-progress "$str_left" "${str_middle_corrected}" #"[  $(tui-indi)   ]"
			sleep 1
		done
		tui-status $? "${MSG_ACT_ING}: ${THIS}"
	done 
